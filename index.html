<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameTorrent - Лучшие игры через торрент</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: #0f0f1b;
            color: #ffffff;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Все предыдущие стили остаются без изменений */
        /* ... */

        /* Добавляем стиль для статуса синхронизации */
        .sync-status {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #05d9e8;
        }

        .sync-error {
            color: #ff2a6d;
        }

        .loading {
            color: #ffd700;
        }
    </style>
</head>
<body>
    <!-- Вся предыдущая разметка без изменений -->
    <!-- Модальные окна, шапка, игры и т.д. -->

    <script>
        // Конфигурация GitHub Gist с ТВОИМ ID!
        const GIST_CONFIG = {
            GIST_ID: 'a436e46e9609a0beb1123d4137227931', // ТВОЙ GIST ID!
            FILENAME: 'gametorrent_ratings.json',
            GITHUB_TOKEN: null
        };

        // Данные игр (без изменений)
        const gamesData = [
            {
                id: 'cyberpunk',
                name: 'Cyberpunk 2077',
                year: 2020,
                size: '65.2 GB',
                genre: 'RPG',
                description: 'Ролевая игра в открытом мире от создателей The Witcher.',
                image: 'images/Обложка_компьютерной_игры_Cyberpunk_2077.jpg',
                torrent: 'torrents/cyberpunk-2077.torrent',
                rating: '4.8/5'
            },
            {
                id: 'elden',
                name: 'Elden Ring',
                year: 2022,
                size: '48.3 GB',
                genre: 'RPG',
                description: 'Фэнтезийная ролевая игра от создателей Dark Souls.',
                image: 'images/Elden_Ring_-_cover.jpg',
                torrent: 'torrents/Elden-Ring-by-Igruha.torrent',
                rating: '4.9/5'
            },
            {
                id: 'witcher',
                name: 'The Witcher 3: Wild Hunt',
                year: 2015,
                size: '35.1 GB',
                genre: 'RPG',
                description: 'Эпическая ролевая игра в фэнтезийном мире.',
                image: 'images/The_Witcher_3-_Wild_Hunt_Cover.jpg',
                torrent: 'torrents/The-Witcher-3-Wild-Hunt-Complete-Edition-by-Igruha.torrent',
                rating: '4.9/5'
            },
            {
                id: 'reddead',
                name: 'Red Dead Redemption 2',
                year: 2019,
                size: '109 GB',
                genre: 'Приключения',
                description: 'Приключенческий вестерн от создателей GTA V.',
                image: 'images/Red_Dead_Redemption_2_coverart.jpg',
                torrent: 'torrents/red-dead-redemption-2-by-xatab.torrent',
                rating: '4.8/5'
            },
            {
                id: 'metalgear',
                name: 'Metal Gear Rising: Revengeance',
                year: 2013,
                size: '25 GB',
                genre: 'Экшен',
                description: 'Экшен с механикой разрезания всего на части. РЕЖИ И РУБИ!',
                image: 'images/Metal_Gear_Rising_Revengeance_box_artwork.jpg',
                torrent: 'torrents/Metal-Gear-Rising-Revengeance-by-Igruha.torrent',
                rating: '4.5/5'
            },
            {
                id: 'devilmaycry',
                name: 'Devil May Cry 5',
                year: 2019,
                size: '35 GB',
                genre: 'Экшен',
                description: 'Культовый слэшер с тремя протагонистами. СТИЛЬНЫЕ КОМБО!',
                image: 'images/DevilMayCry5.jpg',
                torrent: 'torrents/Devil-May-Cry-5-by-Igruha.torrent',
                rating: '4.6/5'
            },
            {
                id: 'counterstrike',
                name: 'Counter-Strike 1.6',
                year: 2003,
                size: '0.5 GB',
                genre: 'Шутеры',
                description: 'Культовый тактический шутер. ЛЕГЕНДА КИБЕРСПОРТА!',
                image: 'images/Counter-Strike_Box_1.jpg',
                torrent: 'torrents/Counter-strike-1.6.torrent',
                rating: '4.3/5'
            },
            {
                id: 'left4dead',
                name: 'Left 4 Dead 2',
                year: 2009,
                size: '8 GB',
                genre: 'Шутеры',
                description: 'Кооперативный зомби-шутер от Valve.',
                image: 'images/capsule_616x353.jpg',
                torrent: 'torrents/Left-4-Dead-2-by-Igruha.torrent',
                rating: '4.4/5'
            },
            {
                id: 'halflife',
                name: 'Half-Life',
                year: 1998,
                size: '0.5 GB',
                genre: 'Шутеры',
                description: 'ЛЕГЕНДАРНЫЙ ШУТЕР ОТ VALVE! Начало истории Гордона Фримена.',
                image: 'images/capsule_616x354.jpg',
                torrent: 'torrents/Half-Life.torrent',
                rating: '4.2/5'
            },
            {
                id: 'halflife2',
                name: 'Half-Life 2',
                year: 2004,
                size: '4.5 GB',
                genre: 'Шутеры',
                description: 'ШЕДЕВР ОТ VALVE! Продолжение легенды с гравипушкой!',
                image: 'images/HL2box.jpg',
                torrent: 'torrents/Half-Life-2-Complete-Edition-by-Igruha.torrent',
                rating: '4.8/5'
            }
        ];

        // Глобальные переменные
        let siteStats = {
            totalRating: 0,
            voteCount: 0,
            averageRating: 0,
            userRatings: {},
            comments: [],
            lastUpdate: new Date().toISOString()
        };

        let gameDownloads = {};
        let currentUser = null;
        let users = [];

        // ==================== GITHUB GIST ФУНКЦИИ ====================

        // Загрузка данных из Gist
        const loadFromGist = async () => {
            try {
                showSyncStatus('Загрузка данных...', 'loading');
                
                const response = await fetch(`https://api.github.com/gists/${GIST_CONFIG.GIST_ID}`);
                
                if (!response.ok) {
                    throw new Error('Gist не найден');
                }
                
                const gistData = await response.json();
                const content = gistData.files[GIST_CONFIG.FILENAME].content;
                
                const remoteData = JSON.parse(content);
                
                // Объединяем данные
                siteStats = {...siteStats, ...remoteData.siteStats};
                gameDownloads = {...gameDownloads, ...remoteData.gameDownloads};
                
                showSyncStatus('Данные загружены ✓', 'success');
                return true;
                
            } catch (error) {
                console.log('Ошибка загрузки из Gist:', error);
                showSyncStatus('Ошибка загрузки данных', 'error');
                return false;
            }
        };

        // Сохранение данных в Gist
        const saveToGist = async () => {
            try {
                showSyncStatus('Синхронизация...', 'loading');
                
                const dataToSave = {
                    siteStats: {
                        ...siteStats,
                        lastUpdate: new Date().toISOString()
                    },
                    gameDownloads,
                    schemaVersion: '1.0'
                };

                const updateData = {
                    files: {
                        [GIST_CONFIG.FILENAME]: {
                            content: JSON.stringify(dataToSave, null, 2)
                        }
                    }
                };

                const response = await fetch(`https://api.github.com/gists/${GIST_CONFIG.GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    throw new Error('Ошибка сохранения');
                }

                showSyncStatus('Данные синхронизированы ✓', 'success');
                return true;
                
            } catch (error) {
                console.log('Ошибка сохранения в Gist:', error);
                showSyncStatus('Ошибка синхронизации', 'error');
                
                // Fallback на localStorage
                saveToLocalStorage();
                return false;
            }
        };

        // Локальное сохранение (fallback)
        const saveToLocalStorage = () => {
            try {
                localStorage.setItem('gameTorrentSiteRating', JSON.stringify(siteStats));
                localStorage.setItem('gameTorrentDownloads', JSON.stringify(gameDownloads));
                localStorage.setItem('gameTorrentUsers', JSON.stringify(users));
                if (currentUser) {
                    localStorage.setItem('gameTorrentCurrentUser', JSON.stringify(currentUser));
                }
            } catch (e) {
                console.log('Ошибка локального сохранения');
            }
        };

        // Показать статус синхронизации
        const showSyncStatus = (message, type = 'info') => {
            let statusElement = document.getElementById('syncStatus');
            if (!statusElement) {
                statusElement = document.createElement('div');
                statusElement.id = 'syncStatus';
                statusElement.className = 'sync-status';
                document.querySelector('.site-rating').appendChild(statusElement);
            }
            
            statusElement.textContent = message;
            statusElement.className = `sync-status ${type === 'error' ? 'sync-error' : type === 'loading' ? 'loading' : ''}`;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    statusElement.textContent = '';
                }, 3000);
            }
        };

        // ==================== ОСНОВНЫЕ ФУНКЦИИ ====================

        // Инициализация данных
        const initializeData = async () => {
            gamesData.forEach(game => {
                gameDownloads[game.id] = gameDownloads[game.id] || 0;
            });

            try {
                const gistLoaded = await loadFromGist();
                
                if (!gistLoaded) {
                    const savedStats = localStorage.getItem('gameTorrentSiteRating');
                    const savedDownloads = localStorage.getItem('gameTorrentDownloads');
                    const savedUsers = localStorage.getItem('gameTorrentUsers');
                    const currentUserData = localStorage.getItem('gameTorrentCurrentUser');
                    
                    if (savedStats) {
                        const parsed = JSON.parse(savedStats);
                        siteStats = {...siteStats, ...parsed};
                    }
                    if (savedDownloads) {
                        const parsed = JSON.parse(savedDownloads);
                        gameDownloads = {...gameDownloads, ...parsed};
                    }
                    if (savedUsers) {
                        users = JSON.parse(savedUsers);
                    }
                    if (currentUserData) {
                        currentUser = JSON.parse(currentUserData);
                    }
                }
            } catch (e) {
                console.log('Ошибка инициализации данных');
            }
        };

        // Сохранение данных
        const saveData = async () => {
            await saveToGist();
        };

        // Отображение игр
        const renderGames = (games = gamesData) => {
            const gamesGrid = document.getElementById('gamesGrid');
            gamesGrid.innerHTML = '';

            games.forEach(game => {
                const gameCard = `
                    <div class="game-card" data-game="${game.id}">
                        <img src="${game.image}" alt="${game.name}" class="game-img">
                        <div class="game-info">
                            <h3 class="game-title">${game.name}</h3>
                            <div class="game-meta">
                                <span class="game-year">${game.year}</span>
                                <span class="game-genre">${game.genre}</span>
                                <span class="game-size">${game.size}</span>
                            </div>
                            <p class="game-description">${game.description}</p>
                            <div class="game-stats">
                                <div class="rating">
                                    <span class="stars">${getStarsFromRating(game.rating)}</span>
                                    <span>${game.rating}</span>
                                </div>
                                <div class="downloads">
                                    <span>📥 <span id="downloads-${game.id}">${gameDownloads[game.id] || 0}</span></span>
                                </div>
                            </div>
                            <a href="#" class="download-btn" onclick="return downloadGame('${game.id}')">Скачать торрент</a>
                        </div>
                    </div>
                `;
                gamesGrid.innerHTML += gameCard;
            });
        };

        // Функция для получения звезд из рейтинга
        const getStarsFromRating = (rating) => {
            const num = parseFloat(rating);
            const fullStars = Math.floor(num);
            const hasHalfStar = num % 1 >= 0.5;
            let stars = '★'.repeat(fullStars);
            if (hasHalfStar) stars += '½';
            stars += '☆'.repeat(5 - fullStars - (hasHalfStar ? 1 : 0));
            return stars;
        };

        // Функция для получения правильного окончания
        const getVotesText = (count) => {
            if (count === 0) return 'голосов';
            if (count % 10 === 1 && count % 100 !== 11) return 'голос';
            if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) return 'голоса';
            return 'голосов';
        };

        // Генерация звезд рейтинга
        const getStars = (rating) => {
            if (rating === 0) return '☆☆☆☆☆';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let stars = '★'.repeat(fullStars);
            if (hasHalfStar) stars += '½';
            stars += '☆'.repeat(5 - fullStars - (hasHalfStar ? 1 : 0));
            return stars;
        };

        // Функция создания торрент-файла
        const createTorrentFile = (gameName, gameId) => {
            const torrentContent = `d8:announce41:http://tracker.gametorrent.com:8080/announce13:announce-listll41:http://tracker.gametorrent.com:8080/announceel44:udp://tracker.gametorrent.com:8080/announceee7:comment35:Downloaded from GameTorrent - Best Games!10:created by13:GameTorrent v1.013:creation datei${Math.floor(Date.now() / 1000)}e8:encoding5:UTF-84:infod6:lengthi${getGameSize(gameId)}e4:name${gameName.length}:${gameName}12:piece lengthi262144e6:pieces20:aaaaaaaaaaaaaaaaaaaaee`;
            
            const blob = new Blob([torrentContent], { type: 'application/x-bittorrent' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${gameName}.torrent`;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        };

        // Функция для получения размера игры
        const getGameSize = (gameId) => {
            const sizes = {
                cyberpunk: 65.2 * 1024 * 1024 * 1024,
                elden: 48.3 * 1024 * 1024 * 1024,
                witcher: 35.1 * 1024 * 1024 * 1024,
                reddead: 109 * 1024 * 1024 * 1024,
                metalgear: 25 * 1024 * 1024 * 1024,
                devilmaycry: 35 * 1024 * 1024 * 1024,
                counterstrike: 0.5 * 1024 * 1024 * 1024,
                left4dead: 8 * 1024 * 1024 * 1024,
                halflife: 0.5 * 1024 * 1024 * 1024,
                halflife2: 4.5 * 1024 * 1024 * 1024
            };
            return sizes[gameId] || 1024 * 1024 * 1024;
        };

        // Функция скачивания игры
        const downloadGame = async (gameId) => {
            if (gameDownloads[gameId] !== undefined) {
                gameDownloads[gameId]++;
                
                await saveData();
                updateStats();

                const game = gamesData.find(g => g.id === gameId);
                const gameName = game.name;
                
                alert(`Начинается скачивание "${gameName}"! 🎮\nСкачано раз: ${gameDownloads[gameId]}`);
                
                createTorrentFile(gameName, gameId);
            }

            return false;
        };

        // Обновление статистики
        const updateStats = () => {
            Object.keys(gameDownloads).forEach(game => {
                const element = document.getElementById(`downloads-${game}`);
                if (element) {
                    element.textContent = gameDownloads[game];
                }
            });

            const ratingElement = document.getElementById('siteRating');
            const votesElement = document.getElementById('siteVotes');
            const starsElement = document.getElementById('siteStars');
            
            if (ratingElement) ratingElement.textContent = siteStats.averageRating.toFixed(1);
            if (votesElement) votesElement.textContent = `${siteStats.voteCount} ${getVotesText(siteStats.voteCount)}`;
            if (starsElement) starsElement.innerHTML = getStars(siteStats.averageRating);

            updateComments();
            updateAuthUI();

            if (siteStats.lastUpdate) {
                const updateTime = new Date(siteStats.lastUpdate).toLocaleString('ru-RU');
                showSyncStatus(`Обновлено: ${updateTime}`, 'info');
            }
        };

        // Обновление комментариев
        const updateComments = () => {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';

            if (siteStats.comments.length === 0) {
                commentsList.innerHTML = '<div class="no-comments">Пока нет отзывов. Будьте первым!</div>';
                return;
            }

            const sortedComments = [...siteStats.comments].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            ).slice(0, 5);

            sortedComments.forEach(comment => {
                const commentElement = `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${comment.username}</span>
                            <span class="comment-rating">${'★'.repeat(comment.rating)}${'☆'.repeat(5-comment.rating)}</span>
                        </div>
                        <div class="comment-text">${comment.text}</div>
                        <div style="font-size: 12px; color: #666687; margin-top: 5px;">${comment.date}</div>
                    </div>
                `;
                commentsList.innerHTML += commentElement;
            });
        };

        // Обновление UI авторизации
        const updateAuthUI = () => {
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const userName = document.getElementById('userName');
            const rateSection = document.getElementById('rateSection');
            const authRequired = document.getElementById('authRequired');
            const commentForm = document.getElementById('commentForm');

            if (currentUser) {
                authButtons.style.display = 'none';
                userInfo.style.display = 'flex';
                userName.textContent = currentUser.username;
                rateSection.style.display = 'block';
                authRequired.style.display = 'none';
                commentForm.style.display = 'block';

                if (siteStats.userRatings[currentUser.id]) {
                    const buttons = document.querySelectorAll('.rate-btn');
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        btn.style.background = '#1a1a2e';
                        btn.style.color = '#666687';
                        btn.style.cursor = 'not-allowed';
                    });
                    document.getElementById('alreadyRated').style.display = 'block';
                    document.getElementById('userRatingInfo').style.display = 'block';
                    document.getElementById('userRatingValue').textContent = siteStats.userRatings[currentUser.id] + ' звезд';
                } else {
                    document.getElementById('alreadyRated').style.display = 'none';
                    document.getElementById('userRatingInfo').style.display = 'none';
                }
            } else {
                authButtons.style.display = 'flex';
                userInfo.style.display = 'none';
                rateSection.style.display = 'none';
                authRequired.style.display = 'block';
                commentForm.style.display = 'none';
            }
        };

        // Функция оценки сайта
        const rateSite = async (rating) => {
            if (!currentUser) {
                alert('Для оценки сайта требуется авторизация!');
                showLogin();
                return;
            }

            if (siteStats.userRatings[currentUser.id]) {
                alert('Вы уже оценили наш сайт! Спасибо! ❤️');
                return;
            }
            
            siteStats.userRatings[currentUser.id] = rating;
            
            const ratings = Object.values(siteStats.userRatings);
            siteStats.totalRating = ratings.reduce((sum, r) => sum + r, 0);
            siteStats.voteCount = ratings.length;
            siteStats.averageRating = siteStats.totalRating / siteStats.voteCount;
            
            await saveData();
            updateStats();
            
            alert(`Спасибо за вашу оценку ${rating} звезд! ⭐\nТеперь все пользователи увидят ваш вклад!\n\nОбщий рейтинг сайта: ${siteStats.averageRating.toFixed(1)}/5`);
        };

        // Функция отправки комментария
        const submitComment = async () => {
            if (!currentUser) {
                alert('Для отправки отзыва требуется авторизация!');
                showLogin();
                return;
            }

            const commentText = document.getElementById('commentText').value.trim();
            if (!commentText) {
                alert('Введите текст отзыва!');
                return;
            }

            const userRating = siteStats.userRatings[currentUser.id];
            if (!userRating) {
                alert('Сначала оцените сайт!');
                return;
            }

            const comment = {
                username: currentUser.username,
                rating: userRating,
                text: commentText,
                date: new Date().toLocaleDateString('ru-RU'),
                timestamp: new Date().toISOString()
            };

            siteStats.comments.push(comment);
            await saveData();
            updateStats();

            document.getElementById('commentText').value = '';
            alert('Спасибо за ваш отзыв! ❤️ Теперь его увидят все пользователи!');
        };

        // Функции для модальных окон
        const showLogin = () => {
            document.getElementById('loginModal').style.display = 'block';
        };

        const showRegister = () => {
            document.getElementById('registerModal').style.display = 'block';
        };

        const closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        // Регистрация
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value.trim();

            if (users.find(user => user.email === email)) {
                alert('Пользователь с таким email уже существует!');
                return;
            }

            const newUser = {
                id: 'user_' + Math.random().toString(36).substr(2, 9),
                username: username,
                email: email,
                password: password
            };

            users.push(newUser);
            currentUser = newUser;
            saveToLocalStorage(); // Сохраняем пользователей локально
            updateAuthUI();
            closeModal('registerModal');
            
            alert(`Добро пожаловать, ${username}! 🎮`);
        });

        // Вход
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                saveToLocalStorage(); // Сохраняем текущего пользователя
                updateAuthUI();
                closeModal('loginModal');
                alert(`С возвращением, ${user.username}! 🎮`);
            } else {
                alert('Неверный email или пароль!');
            }
        });

        // Выход
        const logout = () => {
            currentUser = null;
            saveToLocalStorage();
            updateAuthUI();
            alert('Вы вышли из аккаунта!');
        };

        // Поиск игр
        const searchGames = () => {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderGames();
                return;
            }

            const filteredGames = gamesData.filter(game => 
                game.name.toLowerCase().includes(searchTerm) ||
                game.genre.toLowerCase().includes(searchTerm) ||
                game.description.toLowerCase().includes(searchTerm)
            );

            renderGames(filteredGames);
        };

        // Фильтрация по категориям
        const filterByCategory = (category) => {
            if (category === 'all') {
                renderGames();
                return;
            }

            const filteredGames = gamesData.filter(game => game.genre === category);
            renderGames(filteredGames);
        };

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeData();
            renderGames();
            updateStats();
            updateAuthUI();

            // Авто-обновление данных каждые 30 секунд
            setInterval(async () => {
                await loadFromGist();
                updateStats();
            }, 30000);

            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchGames();
                }
            });

            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>
